// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Users {
  id            String     @id @default(cuid())
  name          String
  email         String
  emailVerified Boolean    @default(false)
  image         String?
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @default(now()) @updatedAt @map("updated_at")
  sessionss     Sessions[]
  accountss     Accounts[]
  role          UserRole   @default(EDITOR)
  sidebar       SidebarUser[]
  comments      Comment[]
  alerts        Alert[]
  active        Boolean    @default(false)


  @@unique([email])
  @@index([active])
  @@map("users")    
}

model Sessions {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  users     Users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("sessions")
}

model Accounts {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  users                 Users     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("accounts")
}


model Sidebar {
  id        String   @id @default(cuid())
  labelEn   String
  labelRu   String
  href      String   @unique
  icon      String?
  parentId  String?  
  parent    Sidebar? @relation("ParentChild", fields: [parentId], references: [id], onDelete: SetNull)
  children  Sidebar[] @relation("ParentChild")
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users SidebarUser[] // pivot table
  @@map("sidebar")
}

model SidebarUser {
  id            String   @id @default(cuid())
  userId        String
  sidebarItemId String
  user          Users    @relation(fields: [userId], references: [id])
  sidebarItem   Sidebar  @relation(fields: [sidebarItemId], references: [id])

  @@unique([userId, sidebarItemId])
  @@index([userId])
  @@map("sidebar_user")
}

model GroupCodes {
  id        String   @id @default(cuid())
  code      String   @unique
  labelEn   String
  labelRu   String

  codes Codes[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("group_codes")
  @@index([code])
}

model Codes {
  id        String   @id @default(cuid())
  code      String   @unique
  labelEn   String
  labelRu   String
  groupCodeId String

  groupCode GroupCodes @relation(fields: [groupCodeId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("codes")
  @@index([code])
  @@index([groupCodeId])
}


  

model Applicant {
  id                  String   @id @default(cuid())
  userId              String   @unique // Enforce 6-char format in app/migration

  firstName           String   @map("first_name")
  lastName            String   @map("last_name")
  middleName          String?  @map("middle_name")
  gender              Gender   @default(MALE)

  passportNumber      String   @map("passport_number") // Encrypt in DB/app

  phoneNumber         String   @map("phone_number")
  phoneNumberAdditional String? @map("phone_number_additional")
  email               String   // Made required for contact

  // Address structured for better querying
  countryOfResidence  String   @map("country_of_residence") // Use enum if possible
  addressLine1        String   @map("address_line_1") // Main street
  addressLine2        String?  @map("address_line_2") // Details/apt
  city                String?  @map("city")
  state               String?  @map("state")
  zipCode             String?  @map("zip_code")

  nationality         String?  // ISO code or full name
  dateOfBirth         DateTime? // For age/eligibility checks
  preferredJobTitle   String?  @default("Worker")  // Quick filter for matching

  countryOfEmployment String   @map("country_of_employment")
  partner             String   // e.g., recruiting agency

  status              ApplicantStatus @default(NEW)
  languages           String[] @map("languages")

  // Relations
  work                Work[]
  visa                Visa[]
  files               File[]
  comments            Comment[]

  // Audit
  createdBy           String   @default("System") // Ideally set to user ID
  updatedBy           String   @default("System")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  isArchived          Boolean  @default(false) // For soft deletes
  isAlert             Boolean  @default(false) // For alerts

  @@map("applicants")
  @@index([userId])
  @@index([countryOfEmployment])
  @@index([partner])
  @@index([isArchived])    // New: for active applicant lists
  @@index([isAlert])       // New: for alert lists
}



model Visa {
  id              String      @id @default(cuid())
  applicantId     String      @map("applicant_id")
  applicant       Applicant   @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  
  issued          Boolean     @default(false)
  issueDate       DateTime?   @map("issue_date") // When visa was issued
  departureDate   DateTime?   @map("departure_date") // Only if issued
  arrived         Boolean     @default(false)
  arrivalDate     DateTime?   @map("arrival_date") // Only if arrived
  status          VisaStatus  @default(STILL_WORKING) // still_working, returned, departed
  returnedDate    DateTime?   @map("returned_date") // Only if returned


  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("visas")
  @@index([applicantId])
  @@index([status])
}


model Work {
  id              String    @id @default(cuid())
  applicantId     String    @map("applicant_id")
  applicant       Applicant @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  
  jobTitle        String    @map("job_title") // e.g., "Software Engineer"
  company         String    @map("company") // e.g., "Tech Corp"
  startDate       DateTime  @map("start_date")
  endDate         DateTime? @map("end_date") // Null if current
  responsibilities String    @map("responsibilities") // Text description
  achievements    String?   @map("achievements") // Optional text for key wins
  location        String?   @map("location") // e.g., "New York, NY"

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("work_history")
  @@index([applicantId])
}


model File {
  id              String    @id @default(cuid())
  
  applicantId     String    @map("applicant_id")
  applicant       Applicant @relation(fields: [applicantId], references: [id], onDelete: Cascade)

  
  fileType        FileType  @map("file_type") // e.g., PASSPORT, VISA, CV
  fileKey         String    @map("file_key") // Path in R2 (applicantId/fileType/filename)
  fileName        String    @map("file_name") // Original file name
  fileSize        Int?      @map("file_size") // Size in bytes
  mimeType        String?   @map("mime_type") // e.g., "application/pdf"

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("files")
  @@index([applicantId])
  @@index([fileType])
}

// COMMENTS
model Comment {
  id          String    @id @default(cuid())
  content     String    // The comment text
  applicantId String    @map("applicant_id")
  applicant   Applicant @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  
  // Who created the comment
  authorId    String    @map("author_id")
  author      Users     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Related alerts
  alerts      Alert[]

  @@map("comments")
  @@index([applicantId])
  @@index([authorId])
}

// Alerts model for unread notifications
model Alert {
  id          String    @id @default(cuid())
  
  // The comment that triggered this alert
  commentId   String    @map("comment_id")
  comment     Comment   @relation(fields: [commentId], references: [id], onDelete: Cascade)
  
  // The user who should see this alert
  userId      String    @map("user_id")
  user        Users     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Alert status
  isRead      Boolean   @default(false) @map("is_read")
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("alerts")
  @@index([commentId])
  @@index([userId])
  @@index([isRead])
  @@unique([commentId, userId]) // Each comment creates only one alert per user
}

// ENUMS

enum FileType {
  PASSPORT
  VISA
  CV
  INSURANCE
  FLIGHT_DOCUMENT
  OTHER
}


enum ApplicantStatus {
  NEW                 
  IN_PROGRESS 
  CONFIRMED_PROGRAM

 
  HIRED             
  HOTEL_REJECTED  
  APPLICANT_REJECTED
  FIRED             
}


enum VisaStatus {
  NOT_APPLIED
  STILL_WORKING
  RETURNED
  DEPARTED
}

enum Gender {
  MALE
  FEMALE
}

enum UserRole {
  EDITOR
  ADMIN
  CREATOR
}
